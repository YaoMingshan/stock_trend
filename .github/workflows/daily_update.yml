name: æ¯æ—¥è‚¡ç¥¨åˆ†ææ›´æ–°

on:
  # å®šæ—¶ä»»åŠ¡ - æ¯ä¸ªäº¤æ˜“æ—¥ä¸‹åˆ3:30ï¼ˆUTCæ—¶é—´7:30ï¼‰
  schedule:
    - cron: '30 7 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº” UTC 7:30 = åŒ—äº¬æ—¶é—´ 15:30
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: false
        default: 'quick'
        type: choice
        options:
          - quick
          - full

# è®¾ç½®æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: è¿è¡Œåˆ†æ
        run: |
          python main.py --mode ${{ github.event.inputs.mode || 'quick' }} --force
        env:
          TZ: Asia/Shanghai
      
      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --staged --quiet || git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°: $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M')"
          git push

  # éƒ¨ç½²åˆ°GitHub Pages
  deploy-pages:
    needs: update-analysis
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main  # ç¡®ä¿è·å–æœ€æ–°æäº¤
      
      - name: æ‹‰å–æœ€æ–°æ›´æ”¹
        run: git pull origin main
      
      - name: é…ç½®Pages
        uses: actions/configure-pages@v4
      
      - name: ä¸Šä¼ artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'
      
      - name: éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4